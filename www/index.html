<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" />
        <link rel="stylesheet"  href="css/themes/default/jquery.mobile-1.3.2.min.css">
		<style type="text/css">
		  #map-canvas { height: 100%}
		</style>
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript">
            var dd = $.Deferred();
            var jqd = $.Deferred();
            $.when(dd, jqd).done(doInit);

            $(document).bind('mobileinit', function () {
                jqd.resolve();
            });
            function doInit() {
                FastClick.attach(document.body);
                var ele = document.getElementById("deviceproperties");
                ele.innerHTML = 'Device Model: '    + device.model    + '<br />' +
                            	'Device Cordova: '  + device.cordova  + '<br />' +
                            	'Device Platform: ' + device.platform + '<br />' +
        		                'Device UUID: '     + device.uuid     + '<br />' +
		                        'Device Version: '  + device.version  + '<br />';

            }
            $.support.cors = true;
            $.mobile.allowCrossDomainPages = true;
            $.mobile.buttonMarkup.hoverDelay = 10;
        </script>
        <script type="text/javascript" src="js/jquery.mobile-1.3.2.min.js"></script>
        <script type="application/javascript" src="js/fastclick.min.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript">
            document.addEventListener('deviceready', deviceReady, false);
            function deviceReady() {
                dd.resolve();
            }
        </script>
		<script type="text/javascript"
		  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDb1xlbN5xo9lZcWAIn-OQKm1jH56xs904&libraries=places&amp;sensor=false">
		</script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
		<script type="text/javascript">

                var nextID = 1;

                var tempVote = 0;

                var votes = 0;

            function initialize() {
                var mapOptions = {
                    center: new google.maps.LatLng(51.455, -2.588),
                    zoom: 13,
                    minZoom: 13
                };
                var map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);

                // Listen for clicks to add trees 
                google.maps.event.addListener(map, 'click', function(event) {
                    if(map.getZoom() > 15) placeMarker(event.latLng, map);
                });
 
                // Rough BS1-16 (Bristol council jurisdiction) postcode bounds, needs refining to a polygon
                var allowedBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(51.389244, -2.709939), 
                new google.maps.LatLng(51.552326,-2.41893));

                var lastValidCenter = map.getCenter();

                google.maps.event.addListener(map, 'center_changed', function() {
                    if (allowedBounds.contains(map.getCenter())) {
                        lastValidCenter = map.getCenter();
                        return; 
                    }
                    map.panTo(lastValidCenter);
                });
                // String to display when user tries to place tree in disallowed area
                var badArea = 'Sorry, this area is unsuitable for tree planting';

                // Infowindow to display when tree planting is attempted in disallowed area
                var infowindow = new google.maps.InfoWindow({ 
                content: badArea
                });

                // Coordinates for disallowed area
                var polyCoords = [
                    new google.maps.LatLng(51.422368, -2.600615), new google.maps.LatLng(51.422281, -2.599920), new google.maps.LatLng(51.422303, -2.598823), 
                    new google.maps.LatLng(51.421931, -2.598190), new google.maps.LatLng(51.421291, -2.598362), new google.maps.LatLng(51.420220, -2.599207), 
                    new google.maps.LatLng(51.420162, -2.599341), new google.maps.LatLng(51.420210, -2.599928), new google.maps.LatLng(51.420321, -2.600121), 
                    new google.maps.LatLng(51.420759, -2.600387), new google.maps.LatLng(51.420884, -2.600556), new google.maps.LatLng(51.421294, -2.600470), 
                    new google.maps.LatLng(51.421716, -2.600202), new google.maps.LatLng(51.421925, -2.600481), new google.maps.LatLng(51.421946, -2.600620), 
                ];

                // Polygon for disallowed area
                shading = new google.maps.Polygon({
                    paths: polyCoords,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.5,
                    strokeWeight: 1,
                    fillColour: '#FF0000',
                    fillOpacity: 0.3
                });

                // Makes disallowed area polygon only appear above a certain zoom level 
                google.maps.event.addListener(map, "zoom_changed", function() { 
                    if(map.getZoom() > 15) shading.setMap(map);
                    else shading.setMap(null);
                    });

                google.maps.event.addListener(shading, 'click', function(event)
                {
                    infowindow.open(map);
                    infowindow.setPosition(event.latLng);
                });
                
                // Create the search box and link it to the UI element.
                var input = document.getElementById('search-input');
                //map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

                var searchBox = new google.maps.places.Autocomplete(input);

                // Listen for the event fired when the user selects an item from the
                // pick list. Retrieve the matching place for that item.
                google.maps.event.addListener(searchBox, 'place_changed', function() {
                    var place = searchBox.getPlace();
                    map.setCenter(place.geometry.location);
                    map.setZoom(16);
                });
                
                // Bias the SearchBox results towards places that are within the bounds of the
                // current map's viewport.
                google.maps.event.addListener(map, 'bounds_changed', function() {
                    var bounds = map.getBounds();
                    searchBox.setBounds(bounds);
                });

                // Set height
                h = $(window).height();
				document.getElementById('map-canvas').style.height = h-120+"px"; // Under the assumption header/footer are 60px tall, may need changing
            }

            

            // Function to place marker
            function placeMarker(location, map) {
                var marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: 'Tree/username',    
                    animation: google.maps.Animation.DROP,
                    icon: 'img/tree1.png',
                    id: nextID,
                    votes: 0
                });
                nextID++;
                attachMessage(marker);
            }

            // Attaches infowindow to each marker
            function attachMessage(marker) {
                var msggg = 'You have voted for me!';
                var id = marker.get('id');
                votes = marker.get('votes');
                var contentString = '<p><b>First tree</b><p>The first tree to be planted in Bristol will be a large Ash tree in the city centre. ' + votes +
                  '<button type="button" onclick="addVote(votes);">Vote for me!</button>';

                marker.set('votes', tempVote);
                // var boxText = document.createElement("div");
                // boxText.style.cssText = "border: 2px solid black; margin-top: 10px; background: grey; padding: 10px;";
                // boxText.innerHTML = "<p><b>First tree</b><p>The first tree to be planted in Bristol will be a large Ash tree in the city centre.";        
                // infobox = new InfoBox({
                //      content: boxText,
                //      disableAutoPan: false,
                //      maxWidth: 150,
                //      pixelOffset: new google.maps.Size(-140, 0),
                //      zIndex: null,
                //      boxStyle: {
                //         background: "url('http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/examples/tipbox.gif') no-repeat",
                //         opacity: 0.75,
                //         width: "280px"
                //     },
                //     closeBoxMargin: "16px 8px 6px 6px",
                //     closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif",
                //     infoBoxClearance: new google.maps.Size(1, 1)
                // });


                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                })

                // google.maps.event.addListener(marker, 'click', function() {
                //     infobox.open(marker.get('map'), this);
                //     map.panTo(loc);
                // });
                
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(marker.get('map'),marker);
                });
                
            }

                function addVote(votes) {
                  tempVote = votes++;
                }

            


            google.maps.event.addDomListener(window, 'load', initialize);
		</script>
        <title>Democratree</title>
    </head>

    <body> 

        <!-- map page -->
        <div data-role="page" id="map_page">

            <div data-role="header" data-position="fixed" data-id="fixed_header">
                <a data-icon="bars" href="#map_left_panel" data-iconpos="notext">Menu</a>
                <h1>Map</h1>
            </div><!-- /header -->
            
            <div data-role="content" id="map-canvas">
                <div id="deviceproperties"></div>
            </div><!-- /content -->
			
            <div data-role="footer" data-position="fixed" data-id="fixed_footer">
                <h4>Page Footer</h4>
            </div><!-- /footer -->

            <div data-role="panel" id="map_left_panel">
                <ul data-role="listview">
                    <li data-role="list-divider">Democratree</li>
                    <li><a href="#leaderboard_page">Leaderboard</a></li>
                    <li><input id="search-input" data-mini="true" data-clear-btn="true" type="text" placeholder="Search"></li>
                </ul>
                
            </div><!-- /panel -->

        </div><!-- /page -->


        <!-- Start of second page -->
        <div data-role="page" id="leaderboard_page">

            <div data-role="header" data-position="fixed" data-id="fixed_header">
                <a data-icon="bars" href="#leaderboard_left_panel" data-iconpos="notext">Menu</a>
                <h1>Leaderboard</h1>
            </div><!-- /header -->

            <div data-role="content">   
                <p>Leaderboard Leaderboard Leaderboard Leaderboard Leaderboard Leaderboard </p>      
            </div><!-- /content -->

            <div data-role="footer" data-position="fixed" data-id="fixed_footer">
                <h4>Page Footer</h4>
            </div><!-- /footer -->

            <div data-role="panel" id="leaderboard_left_panel">
                <ul data-role="listview">
                    <li data-role="list-divider">Democratree</li>
                    <li><a href="#map_page">Map</a></li>
                </ul>
            </div><!-- /panel -->
        </div><!-- /page -->
    </body>
</html>
