<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" />
        <link rel="stylesheet"  href="css/themes/default/jquery.mobile-1.3.2.min.css">
		<style type="text/css">
		  #map-canvas { height: 100%}
		</style>
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript">
            var dd = $.Deferred();
            var jqd = $.Deferred();
            $.when(dd, jqd).done(doInit);

            $(document).bind('mobileinit', function () {
                jqd.resolve();
            });
            function doInit() {
                FastClick.attach(document.body);
                var ele = document.getElementById("deviceproperties");
                ele.innerHTML = 'Device Model: '    + device.model    + '<br />' +
                            	'Device Cordova: '  + device.cordova  + '<br />' +
                            	'Device Platform: ' + device.platform + '<br />' +
        		                'Device UUID: '     + device.uuid     + '<br />' +
		                        'Device Version: '  + device.version  + '<br />';

            }
            $.support.cors = true;
            $.mobile.allowCrossDomainPages = true;
            $.mobile.buttonMarkup.hoverDelay = 10;
        </script>
        <script type="text/javascript" src="js/jquery.mobile-1.3.2.min.js"></script>
        <script type="application/javascript" src="js/fastclick.min.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.16.min.js"></script>
        <script type="text/javascript" src="js/json2.js"></script>
        <script type="text/javascript" src="js/jstorage.js"></script>
        <script type="text/javascript">
            document.addEventListener('deviceready', deviceReady, false);
            function deviceReady() {
                dd.resolve();
            }
        </script>
		<script type="text/javascript"
		  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDb1xlbN5xo9lZcWAIn-OQKm1jH56xs904&libraries=places&amp;sensor=false">
		</script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
	<script type="text/javascript">

        Parse.initialize("Pw7r5n6AfEqyu1qCWzPGFveMWwfkBDiNSAE33dnL", "eTo4A3yQclInUHyVSj96zDP45Hdy6XIxHtfl2yIe");

	    var treeCount = 0;
        var markerCount = 0;
        var treeArray = new Array();
        var gmarkers = new Array();
        var infoWindowArray = new Array();
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(51.455, -2.588),
                zoom: 13,
                minZoom: 13
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);

            // Listen for clicks to add labels
            google.maps.event.addListener(map, 'click', function(event) {
                infowindow.open(map);
                infowindow.setPosition(event.latLng);
            });

            // Rough BS1-16 (Bristol council jurisdiction) postcode bounds, needs refining to a polygon
            var allowedBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(51.389244, -2.709939), 
            new google.maps.LatLng(51.552326,-2.41893));

            var lastValidCenter = map.getCenter();

            google.maps.event.addListener(map, 'center_changed', function() {
                if (allowedBounds.contains(map.getCenter())) {
                    lastValidCenter = map.getCenter();
                    return; 
                }
                map.panTo(lastValidCenter);
            });
            
            // String to display when user tries to place tree in disallowed area
            var badArea = 'Sorry, this area is unsuitable for tree planting';

            // Infowindow to display when tree planting is attempted in disallowed area
            var infowindow = new google.maps.InfoWindow({ 
                content: badArea
            });

            // Coordinates for disallowed area
            var polyCoords = [
                new google.maps.LatLng(51.422368, -2.600615), new google.maps.LatLng(51.422281, -2.599920), new google.maps.LatLng(51.422303, -2.598823), 
                new google.maps.LatLng(51.421931, -2.598190), new google.maps.LatLng(51.421291, -2.598362), new google.maps.LatLng(51.420220, -2.599207), 
                new google.maps.LatLng(51.420162, -2.599341), new google.maps.LatLng(51.420210, -2.599928), new google.maps.LatLng(51.420321, -2.600121), 
                new google.maps.LatLng(51.420759, -2.600387), new google.maps.LatLng(51.420884, -2.600556), new google.maps.LatLng(51.421294, -2.600470), 
                new google.maps.LatLng(51.421716, -2.600202), new google.maps.LatLng(51.421925, -2.600481), new google.maps.LatLng(51.421946, -2.600620), 
            ];

            var circleOptions = {
                strokeColor: '#FF0000',
                strokeOpacity: 0.1,
                strokeWeight: 2,
                fillColor: '#66FF66',
                fillOpacity: 0.1,
                map: map,
                center: new google.maps.LatLng(51.421274, -2.599345),
                radius: 2500
                };

            plantArea = new google.maps.Circle(circleOptions);

            // Polygon for disallowed area
            shading = new google.maps.Polygon({
                paths: polyCoords,
                strokeColor: '#FF0000',
                strokeOpacity: 0.5,
                strokeWeight: 1,
                fillColour: '#FF0000',
                fillOpacity: 0.3
            });

            google.maps.event.addListener(shading, 'click', function(event) {
                infowindow.open(map);
                infowindow.setPosition(event.latLng);
            });

            // Makes disallowed area polygon only appear above a certain zoom level 
            google.maps.event.addListener(map, "zoom_changed", function() { 
                if(map.getZoom() > 15) shading.setMap(map);
                else shading.setMap(null);
                });
            
            var warning = new google.maps.InfoWindow({ 
                            content: "Please finish placing your previous tree first"
                        });
            
            google.maps.event.addListener(plantArea, 'click', function(event)
            {
                if(map.getZoom() > 15) {
                    if (markerCount != treeCount) {
                        if(warning.getMap() == null) warning.open(map);
                        warning.setPosition(event.latLng);
                    } else placeMarker(event.latLng, map);
                }
            });
                
            // Create the search box and link it to the UI element.
            var input = document.getElementById('search-input');
            //map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

            var autoComplete = new google.maps.places.Autocomplete(input);
            autoComplete.setComponentRestrictions({'country': 'uk'});

            // Listen for the event fired when the user selects an item from the
            // pick list. Retrieve the matching place for that item.
            google.maps.event.addListener(autoComplete, 'place_changed', function() {
                var result = autoComplete.getPlace();
                if(typeof result.address_components == 'undefined') {
                    // The user pressed enter in the input 
                    // without selecting a result from the list
                    var bounds = map.getBounds();
                    autocompleteService = new google.maps.places.AutocompleteService();
                    autocompleteService.getPlacePredictions(
                        {
                            'input': result.name,
                            'offset': result.name.length,
                            'bounds': bounds,
                            'componentRestrictions': {'country': 'uk'}
                        },
                        function listentoresult(list, status) {
                            if(list == null || list.length == 0) {
                                // There are no suggestions available.
                            } else {
                                // Here's the first result that the user saw in the list.
                                placesService = new google.maps.places.PlacesService(document.getElementById('search-input'));
                                placesService.getDetails(
                                    {'reference': list[0].reference},
                                    function detailsresult(detailsResult, placesServiceStatus) {
                                        // Here's the first result in the AutoComplete with the exact
                                        // same data format as you get from the AutoComplete.
                                        document.getElementById('search-input').value = detailsResult.formatted_address;
                                        map.setCenter(detailsResult.geometry.location);
                                        map.setZoom(16);
                                    }
                                );
                            }
                        }
                    );
                } else {
                    map.setCenter(result.geometry.location);
                    map.setZoom(16);
                }
            });
                
            // Bias the SearchBox results towards places that are within the bounds of the
            // current map's viewport.
            google.maps.event.addListener(map, 'bounds_changed', function() {
                var bounds = map.getBounds();
                autoComplete.setBounds(bounds);
            });

            // Set height
            h = $(window).height();
            document.getElementById('map-canvas').style.height = h-120+"px"; // Under the assumption header/footer are 60px tall, may need changing
            // Set cache reset for jStorage
            document.getElementById("resetCache").onclick = function() { 
                for(var i = treeCount-1; i >= 0; i--) {
                    treeArray[i].id = null;
                    treeArray[i] = null;
                    // Remove from map before removing reference
                    gmarkers[i].setMap(null);
                    gmarkers[i] = null;
                    infoWindowArray[i] = null;
                }
                // Check if a tree is in the process of being placed, treeCount should only ever be one less or equal
                if(treeCount != markerCount) {
                    gmarkers[markerCount-1].setMap(null);
                    infoWindowArray[markerCount-1] = null;
                }
                treeArray = [];
                infoWindowArray = [];
                gmarkers = [];
                treeCount = 0;
                markerCount = 0;
                $.jStorage.flush();
            };
            document.getElementById("cacheSize").onclick = function() { console.log($.jStorage.storageSize()); };
            initializeArrays(map);
        } 

        function initializeArrays(map) {
            var results;
            var Tree = Parse.Object.extend("Tree");
            var query = new Parse.Query("Tree");
            query.find({
                // Load each tree
                success: function(results) {
                    for (var i = 0; i < results.length; i++) {
                        var tree = results[i];
                        var latlng = new google.maps.LatLng(tree.get("lat"), tree.get("lng"));
                        var marker = new google.maps.Marker({
                            position: latlng,
                            map: map,
                            title: ""+i,
                            animation: google.maps.Animation.DROP,
                            icon: 'img/tree1.png'
                        });
                        gmarkers.push(marker);
                        attachMessageInit(marker, map, tree, i);
                        treeArray.push(tree.tree);
                    }
                    treeCount = results.length;
                    markerCount = treeCount;
                },
                error: function(error) {
                    alert("failure");
                }
            });
       }

        // Function to place marker
        function placeMarker(location, map) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                title: ""+markerCount,    
                animation: google.maps.Animation.DROP,
                icon: 'img/tree1.png'
            });
            var Tree = Parse.Object.extend("Tree");
            var tree = new Tree();
            tree.set("lat", location.lat());
            tree.set("lng", location.lng());
            tree.set("type", "default");
            tree.set("username", "none");
            tree.set("votes", 0); // Do we want this to default to 0 or 1?
            tree.set("story", "none");
            tree.save();
            markerCount++;
            gmarkers.push(marker);
            map.panTo(location);
            attachMessage(marker, map, tree);
        }
        
        function cancelTree(i) {
            gmarkers[i].setMap(null);
            gmarkers.pop();
            infoWindowArray.pop();
            markerCount--;
        }

        function voteUp(treeInfo, infowindow) {
            //treeInfo.votes++;
            infowindow.setContent('Tree submitted.<p>User Name: ' + treeInfo.username + '<p>Tree Story: ' + treeInfo.story + '<p><p>Votes : ' + treeInfo.votes + '<p><button id="btnVoteUp' + treeInfo.id + '">Vote Up</button>');
            var fullTree={
                    tree : treeInfo,
                    loc : gmarkers[treeInfo.id].position,
            };
            $.jStorage.set("tree"+treeInfo.id, fullTree);
        }

        function addNewTree() {
            var fName=document.forms["myForm"]["Name"].value;
            var fStory=document.forms["myForm"]["Story"].value;

            var treeInfo={
                id : treeCount,
                username : fName,
                story : fStory,
                votes : 0
            };
            /*tree.set("story", fStory);
            tree.set("username", fName);
            tree.save();*/
            infoWindowArray[treeCount].setContent('Tree submitted.<p>User Name: ' + fName + '<p>Tree Story: ' + fStory + '<p><p>Votes: 0<p><button id="btnVoteUp'+treeCount+'">Vote Up</button>');
            treeArray.push(treeInfo);
            if ($.jStorage.storageAvailable() == true) {
                var fullTree={
                    tree : treeInfo,
                    loc : gmarkers[treeCount].position,
                };
                $.jStorage.set("tree"+treeCount, fullTree);
            }
            else {
                console.log("Error - no storage available in jStorage");
            }
            treeCount++;
            return;
        }

        // Attaches infowindow to each marker
        function attachMessage(marker, map, tree) {           
            var contentString = '<p id="textInfoWindow"><b>New Tree Placed</b><p><form id="myForm"> User Name: <input type="text" name="Name"><br> Story: <input type="text" name="Story"><br></form><p><button id="btnSubmitTree" onclick="return addNewTree()">Submit</button><button id="btnCancelTree" onclick="return cancelTree(markerCount-1)">Cancel</button></p>'
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            infoWindowArray.push(infowindow);
            infowindow.open(map, marker);
            google.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map,marker);
            });
            google.maps.event.addListener(infowindow, 'domready', function(){
                var contentStr = '<p id="textInfoWindow"><b>New Tree Placed</b><p><form id="myForm"> User Name: <input type="text" name="Name"><br> Story: <input type="text" name="Story"><br></form><p><button id="btnSubmitTree" onclick="return addNewTree()">Submit</button><button id="btnCancelTree" onclick="return cancelTree(markerCount-1)">Cancel</button></p>'
                // Check to make sure it has been submitted
                if(infowindow.content == contentStr) {}
                else {
                    var str = infowindow.content;
                    // Find the ID
                    var n = str.length-18;  // If content string changes after <button id="btnVoteUp##..., needs changing
                    var m = n;
                    while(str[n] != 'p') {
                        n--;
                    }
                    n++
                    var i = parseInt(str.substring(n, m));
                    // Attach listener
                    var btn = document.getElementById("btnVoteUp"+i);
                    btn.addEventListener('click', function() {
                        voteUp(treeArray[i], infowindow);
                    });
                }
            });
        }
            
        // Create infoWindows when loading from jStorage
        function attachMessageInit(marker, map, tree, i) {
            var infowindow = new google.maps.InfoWindow({
                content: 'Tree submitted.<p>User Name: ' + tree.get("username") + '<p>Tree Story: ' + tree.get("story") + '<p>Votes: ' + tree.get("votes") + '<p><button id="btnVoteUp'+i+'">Vote Up</button>'
            })
            infoWindowArray.push(infowindow);
            google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map,marker);
            });
            google.maps.event.addListener(infowindow, 'domready', function(){
                // Attach listener
                var btn = document.getElementById("btnVoteUp"+i);
                btn.addEventListener('click', function() {
                    voteUp(treeArray[i], infowindow);
                });
            });
        }
            
        function compare(a,b) {
            if (a.votes < b.votes)
     			return -1;
            if (a.votes > b.votes)
    			return 1;
            return 0;
	    }

        function sortArray() {
            treeArray.sort(compare);
        }

        function writeLeaderboard() {
            var x=document.getElementById("leaderBoardContent");
            var i;
        }

        google.maps.event.addDomListener(window, 'load', initialize);
        </script>
        <title>Democratree</title>
    </head>

    <body> 

        <!-- map page -->
        <div data-role="page" id="map_page">

            <div data-role="header" data-position="fixed" data-id="fixed_header">
                <a data-icon="bars" href="#map_left_panel" data-iconpos="notext">Menu</a>
                <h1>Map</h1>
            </div><!-- /header -->
            
            <div data-role="content" id="map-canvas">
                <div id="deviceproperties"></div>
            </div><!-- /content -->
			
            <div data-role="footer" data-position="fixed" data-id="fixed_footer">
                <h4>Democratree</h4>
            </div><!-- /footer -->

            <div data-role="panel" id="map_left_panel">
                <ul data-role="listview">
                    <li data-role="list-divider">Democratree</li>
                    <!-- <li><a href="#map_page">Map</a></li> -->
                    <li><input id="search-input" data-mini="true" data-clear-btn="true" type="text" placeholder="Search"></li>
                    <li><a href="#leaderboard_page">Leaderboard</a></li>
                    <li><button type="button" id="resetCache">Reset tree cache</button></li>
                    <li><button type="button" id="cacheSize">Cache size</button></li>
                </ul>
                
            </div><!-- /panel -->

        </div><!-- /page -->


        <!-- Start of second page -->
        <div data-role="page" id="leaderboard_page">

            <div data-role="header" data-position="fixed" data-id="fixed_header">
                <a data-icon="bars" href="#leaderboard_left_panel" data-iconpos="notext">Menu</a>
                <h1>Leaderboard</h1>
            </div><!-- /header -->

            <div data-role="content">   
                <p><table id="leaderboardTable" border="1">
		<tr>
			<td><b>Username</b></td>
			<td><b>Votes</b></td>
		</tr>
		<tr>
			<td>User1</td>
			<td>7</td>
		</tr>
		<tr>
			<td>User2</td>
			<td>3</td>
		</tr>
		</table>     
            </div><!-- /content -->

            <div data-role="footer" data-position="fixed" data-id="fixed_footer">
                <h4>Democratree</h4>
            </div><!-- /footer -->

            <div data-role="panel" id="leaderboard_left_panel">
                <ul data-role="listview">
                    <li data-role="list-divider">Democratree</li>
                    <li><a href="#map_page">Map</a></li>
                    <li><a href="#leaderboard_page">Leaderboard</a></li>
                </ul>
            </div><!-- /panel -->
        </div><!-- /page -->
    </body>
</html>
    function Tree(Latitude, Longitude, Score, Type)
    {
        this.Latitude = Latitude;
        this.Longitude = Longitude;
        this.Score = Score;
        this.Type = Type;
    }